<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹ÙˆÙ†Ø§Øª</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f0f2f5; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; padding: 10px; }
        .container { background: white; padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 450px; }
        h2 { color: #1a73e8; text-align: center; }
        #login-box { display: block; }
        #system-content { display: none; }
        input, select, button { width: 100%; padding: 15px; margin-top: 15px; border-radius: 12px; border: 2px solid #ddd; font-size: 1.1em; outline: none; box-sizing: border-box; }
        button { background-color: #1a73e8; color: white; border: none; font-weight: bold; cursor: pointer; }
        #reader { width: 100%; border-radius: 20px; overflow: hidden; background: #000; margin-top: 15px; }
        #result { display: none; text-align: right; border-top: 6px solid #28a745; margin-top: 25px; padding-top: 15px; }
        .info { font-size: 1.05em; margin-bottom: 12px; border-bottom: 1px solid #f1f1f1; padding-bottom: 8px; }
        .label { font-weight: bold; color: #5f6368; }
        #msg { margin-top: 15px; font-weight: bold; text-align: center; color: #d93025; }
        .spinner { display: inline-block; width: 18px; height: 18px; border: 3px solid rgba(26,115,232,.3); border-radius: 50%; border-top-color: #1a73e8; animation: spin 1s infinite; vertical-align: middle; margin-left: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div id="login-box">
        <h2>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <select id="username">
            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„ --</option>
            <option value="Ù†Ø¯Ù‰">Ù†Ø¯Ù‰</option>
            <option value="Ø£Ø­Ù…Ø¯">Ø£Ø­Ù…Ø¯</option>
            <option value="Ù…Ø­Ù…Ø¯">Ù…Ø­Ù…Ø¯</option>
        </select>
        <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
        <button onclick="checkLogin()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
    </div>

    <div id="system-content">
        <div id="reader"></div>
        <div class="camera-selector-box" style="margin-top:10px;">
            <select id="cam-list" onchange="changeCamera(this.value)"></select>
        </div>
        <div id="msg"></div>

        <div id="result">
            <div class="info"><span class="label">Ø§Ù„Ø§Ø³Ù…:</span> <span id="res-name"></span></div>
            <div class="info"><span class="label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ:</span> <span id="res-id"></span></div>
            <label class="label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹ÙˆÙ†Ø©:</label>
            <select id="aidType">
                <option value="ÙƒØ±ØªÙˆÙ†Ø© Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©">ğŸ“¦ ÙƒØ±ØªÙˆÙ†Ø© Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©</option>
                <option value="Ù„Ø­ÙˆÙ…">ğŸ¥© Ù„Ø­ÙˆÙ…</option>
            </select>
            <button id="submitBtn" onclick="submitDelivery()">âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</button>
            <button onclick="resetScanner()" style="background: #6c757d;">ğŸ”„ Ù…Ø³Ø­ Ø¬Ø¯ÙŠØ¯</button>
        </div>
    </div>
</div>

<script>
    const users = { "Ù†Ø¯Ù‰": "123", "Ø£Ø­Ù…Ø¯": "123", "Ù…Ø­Ù…Ø¯": "123" };
    // ØªØ£ÙƒØ¯ Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ùˆ Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ Executed API ÙˆÙ„ÙŠØ³ Ø±Ø§Ø¨Ø· Ø§Ù„Ø´ÙŠØª
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzRvIDgFGnJtac_IeSNQ5rjyJUUnes7OLQ3GgrMnoXLnfi9d_BXThR7mULY4HhP6Hnh/exec';
    
    let currentID = "";
    let html5QrCode;

    function checkLogin() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        if (users[u] === p) {
            document.getElementById('login-box').style.display = 'none';
            document.getElementById('system-content').style.display = 'block';
            initCameraList();
        } else { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); }
    }

    function initCameraList() {
        Html5Qrcode.getCameras().then(devices => {
            if (devices && devices.length) {
                const camList = document.getElementById('cam-list');
                devices.forEach((device, i) => {
                    const opt = document.createElement('option');
                    opt.value = device.id;
                    opt.text = device.label || `ÙƒØ§Ù…ÙŠØ±Ø§ ${i+1}`;
                    camList.appendChild(opt);
                });
                startScanner(devices[devices.length - 1].id);
            }
        });
    }

    function startScanner(id) {
        if(html5QrCode) { html5QrCode.stop().then(() => { doStart(id); }); }
        else { doStart(id); }
    }

    function doStart(id) {
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(id, { fps: 10, qrbox: 250 }, (txt) => {
            let scanId = txt;
            if (txt.includes("id=")) {
                const url = new URL(txt);
                scanId = url.searchParams.get("id");
            }
            currentID = scanId;
            html5QrCode.pause(true);
            fetchData(scanId);
        });
    }

    function fetchData(id) {
        const msgDiv = document.getElementById('msg');
        msgDiv.innerHTML = '<div class="spinner"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø±Ù‚Ù…: ' + id;
        
        // Ø£Ø¶ÙÙ†Ø§ Timestamp Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª (Cache)
        fetch(`${scriptURL}?id=${id}&t=${new Date().getTime()}`)
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                console.log("Data received:", data);
                if (data && data !== "Not Found") {
                    document.getElementById('result').style.display = 'block';
                    document.getElementById('res-name').innerText = data[1] || "ØºÙŠØ± Ù…ØªÙˆÙØ±";
                    document.getElementById('res-id').innerText = data[2] || "ØºÙŠØ± Ù…ØªÙˆÙØ±";
                    msgDiv.innerHTML = "";
                } else {
                    alert("âŒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… (" + id + ") ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
                    resetScanner();
                }
            })
            .catch(error => {
                console.error("Fetch error:", error);
                alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø´Ø± Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª ÙƒÙ€ (Anyone) ÙˆÙˆØµÙˆÙ„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.");
                resetScanner();
            });
    }

    function resetScanner() {
        document.getElementById('result').style.display = 'none';
        document.getElementById('msg').innerHTML = "";
        if (html5QrCode) html5QrCode.resume();
    }

    function changeCamera(id) { startScanner(id); }
</script>
</body>
</html>
