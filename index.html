<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุธุงู ุชุณุฌูู ุงููุนููุงุช</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link rel="stylesheet" href="style.css"> </head>
<body>

    <div class="container">
        <div id="login-box">
            <h2>๐ ุชุณุฌูู ุงูุฏุฎูู</h2>
            <select id="username">
                <option value="">-- ุงุฎุชุฑ ุงููุณุฆูู --</option>
                <option value="ูุฏู">ูุฏู</option>
                <option value="ุฃุญูุฏ">ุฃุญูุฏ</option>
                <option value="ูุญูุฏ">ูุญูุฏ</option>
                <option value="ุนูู">ุนูู</option>
                <option value="ุทุงุฑู">ุทุงุฑู</option>
            </select>
            <input type="password" id="password" placeholder="ูููุฉ ุงูุณุฑ">
            <button onclick="checkLogin()">ุฏุฎูู ูููุธุงู</button>
            <p id="login-error" style="color:red; display:none; margin-top:10px; text-align:center;">โ ุจูุงูุงุช ุงูุฏุฎูู ุบูุฑ ุตุญูุญุฉ</p>
        </div>

        <div id="system-content">
            <div class="user-badge">๐ค ุงููุณุฆูู: <span id="logged-user-name"></span></div>
            <div id="reader"></div>
            <button id="resetBtn" onclick="resetScanner()">๐ ูุณุญ ููุฏ ุฌุฏูุฏ</button>
            
            <div id="result">
                <div class="info"><span class="label">ุงูุงุณู:</span> <span id="res-name"></span></div>
                <div class="info"><span class="label">ุงูุฑูู ุงููููู:</span> <span id="res-id"></span></div>
                <div class="info"><span class="label">ุงูุฌูุฉ:</span> <span id="res-org"></span></div>
                <div class="info"><span class="label">ุงูุนููุงู:</span> <span id="res-address"></span></div>
                <div class="info"><span class="label">ุงูููุทูุฉ:</span> <span id="res-region"></span></div>
                <select id="aidType">
                    <option value="ูุฑุชููุฉ ููุงุฏ ุบุฐุงุฆูุฉ">๐ฆ ูุฑุชููุฉ ููุงุฏ ุบุฐุงุฆูุฉ</option>
                    <option value="ูุญูู">๐ฅฉ ูุญูู</option>
                    <option value="ูุนููุฉ ููุฏูุฉ">๐ฐ ูุนููุฉ ููุฏูุฉ</option>
                    <option value="ุฃุฎุฑู">โจ ุฃุฎุฑู</option>
                </select>
                <button id="submitBtn" onclick="submitDelivery()">โ ุชุฃููุฏ ุนูููุฉ ุงูุชุณููู</button>
            </div>
            <div id="msg"></div>
        </div>
    </div>

    <script>
        const users = { "ูุฏู": "123", "ุฃุญูุฏ": "123", "ูุญูุฏ": "123", "ุนูู": "123", "ุทุงุฑู": "123" };
        const scriptURL = 'https://script.google.com/macros/s/AKfycbzUt4afvQZ9Sqk0b011yXNP7vtaNiBowPvFDyCV93tkRBzZ6FvxzYVufqqqUyj_vtNh/exec';
        
        let currentID = "", loggedUser = "", isScanning = true, html5QrcodeScanner;

        function checkLogin() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if (users[u] === p) {
                loggedUser = u;
                document.getElementById('login-box').style.display = 'none';
                document.getElementById('system-content').style.display = 'block';
                document.getElementById('logged-user-name').innerText = loggedUser;
                initScanner();
            } else { document.getElementById('login-error').style.display = 'block'; }
        }

        function initScanner() {
            html5QrcodeScanner = new Html5QrcodeScanner("reader", { 
                fps: 15, // ุฒูุงุฏุฉ ุงููุฑููุงุช ูุณุฑุนุฉ ุงูุงุณุชุฌุงุจุฉ
                qrbox: 250,
                rememberLastUsedCamera: true,
                supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
            });
            html5QrcodeScanner.render(onScanSuccess);
        }

        function onScanSuccess(decodedText) {
            if (!isScanning) return;
            try {
                const url = new URL(decodedText);
                currentID = url.searchParams.get("id");
                if (currentID) {
                    isScanning = false;
                    fetchData(currentID);
                }
            } catch (e) { console.error("QR Error"); }
        }

        function fetchData(id) {
            document.getElementById('msg').innerText = "โณ ุฌุงุฑู ุงูุจุญุซ ุงููุจุงุดุฑ...";
            fetch(`${scriptURL}?id=${id}`)
                .then(res => res.json())
                .then(data => {
                    if (data !== "Not Found") {
                        document.getElementById('result').style.display = 'block';
                        document.getElementById('resetBtn').style.display = 'block';
                        document.getElementById('res-name').innerText = data[1] || "โ";
                        document.getElementById('res-id').innerText = data[2] || "โ";
                        document.getElementById('res-org').innerText = data[12] || "โ";
                        document.getElementById('res-address').innerText = data[5] || "โ";
                        document.getElementById('res-region').innerText = data[6] || "โ";
                        document.getElementById('msg').innerText = "";
                    } else {
                        alert("โ๏ธ ุงููุณุชููุฏ ุบูุฑ ูุณุฌู!");
                        resetScanner();
                    }
                }).catch(() => document.getElementById('msg').innerText = "โ ูุดู ุงูุงุชุตุงู");
        }

        function submitDelivery() {
            const btn = document.getElementById('submitBtn');
            const aid = document.getElementById('aidType').value;
            btn.disabled = true;
            document.getElementById('msg').innerText = "๐ ุฌุงุฑู ุงูุญูุธ...";

            fetch(scriptURL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ id: currentID, aidType: aid, recorderName: loggedUser })
            }).then(() => {
                alert("โ ุชู ุงูุชุณุฌูู ุจูุฌุงุญ");
                resetScanner();
                btn.disabled = false;
            }).catch(() => {
                alert("โ ุฎุทุฃ");
                btn.disabled = false;
            });
        }

        function resetScanner() {
            isScanning = true;
            document.getElementById('result').style.display = 'none';
            document.getElementById('resetBtn').style.display = 'none';
            document.getElementById('msg').innerText = "";
        }
    </script>
</body>
</html>
