<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹ÙˆÙ†Ø§Øª</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f0f2f5; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; padding: 10px; }
        .container { background: white; padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 450px; }
        h2 { color: #1a73e8; text-align: center; }
        #login-box { display: block; }
        #system-content { display: none; }
        input, select, button { width: 100%; padding: 15px; margin-top: 15px; border-radius: 12px; border: 2px solid #ddd; font-size: 1.1em; outline: none; box-sizing: border-box; }
        button { background-color: #1a73e8; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:active { transform: scale(0.98); }
        #reader { width: 100%; border-radius: 20px; overflow: hidden; background: #000; margin-top: 15px; }
        #result { display: none; text-align: right; border-top: 6px solid #28a745; margin-top: 25px; padding-top: 15px; }
        .info { font-size: 1.05em; margin-bottom: 12px; border-bottom: 1px solid #f1f1f1; padding-bottom: 8px; }
        .label { font-weight: bold; color: #5f6368; }
        #msg { margin-top: 15px; font-weight: bold; text-align: center; color: #d93025; min-height: 24px; }
        .spinner { display: inline-block; width: 18px; height: 18px; border: 3px solid rgba(26,115,232,.3); border-radius: 50%; border-top-color: #1a73e8; animation: spin 1s infinite; vertical-align: middle; margin-left: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div id="login-box">
        <h2>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <select id="username">
            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„ --</option>
            <option value="Ù†Ø¯Ù‰">Ù†Ø¯Ù‰</option>
            <option value="Ø£Ø­Ù…Ø¯">Ø£Ø­Ù…Ø¯</option>
            <option value="Ù…Ø­Ù…Ø¯">Ù…Ø­Ù…Ø¯</option>
        </select>
        <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
        <button onclick="checkLogin()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
    </div>

    <div id="system-content">
        <div id="reader"></div>
        <div class="camera-selector-box" style="margin-top:10px;">
            <select id="cam-list" onchange="changeCamera(this.value)"></select>
        </div>
        <div id="msg"></div>

        <div id="result">
            <div class="info"><span class="label">Ø§Ù„Ø§Ø³Ù…:</span> <span id="res-name"></span></div>
            <div class="info"><span class="label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ:</span> <span id="res-id"></span></div>
            <label class="label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹ÙˆÙ†Ø©:</label>
            <select id="aidType">
                <option value="ÙƒØ±ØªÙˆÙ†Ø© Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©">ğŸ“¦ ÙƒØ±ØªÙˆÙ†Ø© Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©</option>
                <option value="Ù„Ø­ÙˆÙ…">ğŸ¥© Ù„Ø­ÙˆÙ…</option>
            </select>
            <button id="submitBtn" onclick="submitDelivery()">âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</button>
            <button onclick="resetScanner()" style="background: #6c757d;">ğŸ”„ Ù…Ø³Ø­ Ø¬Ø¯ÙŠØ¯</button>
        </div>
    </div>
</div>

<script>
    const users = { "Ù†Ø¯Ù‰": "123", "Ø£Ø­Ù…Ø¯": "123", "Ù…Ø­Ù…Ø¯": "123" };
    // Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø°ÙŠ Ø£Ø±Ø³Ù„ØªÙ‡
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzCsWJMmdYZzXLqDUWaLt-veg1JjHxYae9_2v0dI87J9ohfIKIHlRGmqg1SAy5l0LR2/exec';
    
    let currentID = "";
    let html5QrCode;
    let currentUser = "";

    function checkLogin() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        if (users[u] === p) {
            currentUser = u;
            document.getElementById('login-box').style.display = 'none';
            document.getElementById('system-content').style.display = 'block';
            initCameraList();
        } else { alert("Ø®Ø·Ø£ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„"); }
    }

    function initCameraList() {
        Html5Qrcode.getCameras().then(devices => {
            if (devices && devices.length) {
                const camList = document.getElementById('cam-list');
                devices.forEach((device, i) => {
                    const opt = document.createElement('option');
                    opt.value = device.id;
                    opt.text = device.label || `ÙƒØ§Ù…ÙŠØ±Ø§ ${i+1}`;
                    camList.appendChild(opt);
                });
                startScanner(devices[devices.length - 1].id);
            }
        }).catch(err => alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + err));
    }

    function startScanner(id) {
        if(html5QrCode) {
            html5QrCode.stop().then(() => { doStart(id); }).catch(() => { doStart(id); });
        } else { doStart(id); }
    }

    function doStart(id) {
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(id, { fps: 10, qrbox: 250 }, (txt) => {
            let scanId = txt.trim();
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ id=
            if (txt.includes("id=")) {
                const urlParams = new URLSearchParams(txt.split('?')[1]);
                scanId = urlParams.get("id");
            }
            currentID = scanId;
            html5QrCode.pause(true);
            fetchData(scanId);
        }).catch(err => console.error(err));
    }

    function fetchData(id) {
        const msgDiv = document.getElementById('msg');
        msgDiv.innerHTML = '<div class="spinner"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†: ' + id;
        
        fetch(`${scriptURL}?id=${id}`)
            .then(response => response.json())
            .then(data => {
                if (data && data !== "Not Found") {
                    document.getElementById('result').style.display = 'block';
                    document.getElementById('res-name').innerText = data[1] || "ØºÙŠØ± Ù…Ø³Ø¬Ù„"; // Ø¹Ù…ÙˆØ¯ B
                    document.getElementById('res-id').innerText = data[2] || "ØºÙŠØ± Ù…Ø³Ø¬Ù„";   // Ø¹Ù…ÙˆØ¯ C
                    msgDiv.innerHTML = "";
                } else {
                    alert("âŒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª");
                    resetScanner();
                }
            })
            .catch(error => {
                alert("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø´Ø± Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.");
                resetScanner();
            });
    }

    function submitDelivery() {
        const btn = document.getElementById('submitBtn');
        const aid = document.getElementById('aidType').value;
        const msgDiv = document.getElementById('msg');

        btn.disabled = true;
        btn.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";

        const payload = {
            id: currentID,
            aidType: aid,
            recorderName: currentUser
        };

        fetch(scriptURL, {
            method: 'POST',
            mode: 'no-cors', // Ù„Ø¶Ù…Ø§Ù† ØªØ®Ø·ÙŠ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù€ CORS ÙÙŠ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„ÙˆÙŠØ¨ Ø§Ù„Ø¨Ø³ÙŠØ·Ø©
            cache: 'no-cache',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(() => {
            alert("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù€: " + document.getElementById('res-name').innerText);
            resetScanner();
            btn.disabled = false;
            btn.innerText = "âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…";
        })
        .catch(err => {
            alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸");
            btn.disabled = false;
        });
    }

    function resetScanner() {
        document.getElementById('result').style.display = 'none';
        document.getElementById('msg').innerHTML = "";
        if (html5QrCode) html5QrCode.resume();
    }

    function changeCamera(id) { startScanner(id); }
</script>
</body>
</html>
